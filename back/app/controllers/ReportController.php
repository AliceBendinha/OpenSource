<?php
use Dompdf\Dompdf;
class ReportController { private $pdo; public function __construct($pdo){ $this->pdo=$pdo; } public function generate($data){ $farmacia_id=$data['farmacia_id']??null; if(!$farmacia_id){ http_response_code(400); echo json_encode(['error'=>'farmacia_id é obrigatório']); return; } $stmt=$this->pdo->prepare('SELECT * FROM farmacias WHERE id = ?'); $stmt->execute([$farmacia_id]); $f=$stmt->fetch(); if(!$f){ http_response_code(404); echo json_encode(['error'=>'Farmácia não encontrada']); return; } $topP=$this->pdo->prepare('SELECT termo, COUNT(*) as cnt FROM pesquisas WHERE farmacia_id = ? GROUP BY termo ORDER BY cnt DESC LIMIT 10'); $topP->execute([$farmacia_id]); $produtos=$topP->fetchAll(); $html='<h1>Relatório trimestral — ' . htmlspecialchars($f['nome']) . '</h1>'; $html.='<p>Gerado em ' . date('Y-m-d H:i') . '</p>'; $html.='<h2>Termos mais pesquisados</h2><ul>'; foreach($produtos as $p) $html.='<li>' . htmlspecialchars($p['termo']) . ' — ' . $p['cnt'] . '</li>'; $html.='</ul>'; if(!class_exists('Dompdf')){ echo json_encode(['error'=>'DomPDF não instalado. Execute composer require dompdf/dompdf']); return; } $dompdf=new Dompdf(); $dompdf->loadHtml($html); $dompdf->setPaper('A4','portrait'); $dompdf->render(); $file=__DIR__ . '/../../storage/pdfs/relatorio_pharm_' . $farmacia_id . '.pdf'; file_put_contents($file, $dompdf->output()); echo json_encode(['success'=>true,'file'=>'/storage/pdfs/' . basename($file)]); } }
